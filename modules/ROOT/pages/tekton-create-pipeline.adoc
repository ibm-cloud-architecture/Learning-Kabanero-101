= Tekton - Create a Pipeline
:toc:
:imagesdir: images

== Prerequisites

=== Nodejs express

* You need to create an appsody sample application and configure the tekton pipeline.
** For instructions on how to create a nodejs express appsody sample, checkout <<e2e-nodejs-express.adoc#_create_a_new_application, Create a new appsody nodejs express application>>.
** For instructions on how to deploy nodejs express application on openshift, checkout <<e2e-nodejs-express.adoc#_deploy_the_appsody_application_on_openshift_for_team_development, Deploy the appsody application on Openshift>>.
** For instructions on how to access tekton pipeline, checkout <<e2e-nodejs-express.adoc#_accessing_tekton_dashboard, Accessing Tekton dashboard>>.

=== Java Sprinboot

* You need to create an appsody sample application and configure the tekton pipeline.
** For instructions on how to create a java springboot appsody sample, checkout <<e2e-java-spring-boot2.adoc#_create_a_new_application, Create a new appsody java springboot express application>>.
** For instructions on how to deploy java springboot application on openshift, checkout <<e2e-java-spring-boot2.adoc#_deploy_the_appsody_application_on_openshift_for_team_development, Deploy the appsody application on Openshift>>.
** For instructions on how to access tekton pipeline, checkout <<e2e-java-spring-boot2.adoc#_accessing_tekton_dashboard, Accessing Tekton dashboard>>.

=== Java Microprofile

* You need to create an appsody sample application and configure the tekton pipeline.
** For instructions on how to create a java microprofile appsody sample, checkout <<e2e-java-microprofile.adoc#_create_a_new_application, Create a new appsody java microprofile application>>.
** For instructions on how to deploy java microprofile application on openshift, checkout <<e2e-java-microprofile.adoc#_deploy_the_appsody_application_on_openshift_for_team_development, Deploy the appsody application on Openshift>>.
** For instructions on how to access tekton pipeline, checkout <<e2e-java-microprofile.adoc#_accessing_tekton_dashboard, Accessing Tekton dashboard>>.

== Create a Pipeline

With kabanero, every collection comes with a default `build task`, `deploy task` and `build deploy pipeline`.

- Run this command to see the available pipelines.

[source, bash]
----
oc get pipeline -n kabanero
----

You will see something similar to this.

[source, bash]
----
$ oc get pipeline -kabanero
NAME                                           AGE
java-microprofile-build-deploy-pipeline        15d
java-spring-boot2-build-deploy-pipeline        15d
nodejs-build-deploy-pipeline                   15d
nodejs-express-build-deploy-pipeline           15d
nodejs-loopback-build-deploy-pipeline          15d
pipeline0                                      15d
----

You can also access them on the tekton dashboard.

image::sb_lab1_tekton_home.png[align="center"]

- To see the available tasks, use this command.

[source, bash]
----
oc get task -n kabanero
----

You will see something similar to this.

[source, bash]
----
$ oc get task -n kabanero
NAME                             AGE
collections-build-task           13d
java-microprofile-build-task     15d
java-microprofile-deploy-task    15d
java-spring-boot2-build-task     15d
java-spring-boot2-deploy-task    15d
monitor-result-task              15d
nodejs-build-task                15d
nodejs-deploy-task               15d
nodejs-express-build-task        15d
nodejs-express-deploy-task       15d
nodejs-loopback-build-task       15d
nodejs-loopback-deploy-task      15d
pipeline0-task                   15d
----

Let us now see how to define more tasks or create new pipelines for appsody sample applications.

== Nodejs express

Before defining a new task or pipeline, make sure, you do the following steps.

- Create a Nodejs express appsody sample application.
- Push the code to a github repo.
- Create a github access token.
- Access tekton dashboard.

If you did not perform any of the above steps, go to the links provided in the prerequisites.

=== Custom Task

Let us include `npm test` as one of the steps in our new task along with the ones that come by default.

- In this task, we are adding the below step additionally to the ones that come by default.

[source, yaml]
----
- name: npm-test
  securityContext:
    privileged: true
  image: kabanero/nodejs-express:0.2
  command: ["/bin/bash","-c","cd ${inputs.params.pathToContext}/user-app && ls && npm install --prefix user-app && npm install -g mocha && cd .. && npm test && npm test --prefix user-app"]
  env:
    - name: gitsource
      value: git-source
  volumeMounts:
    - mountPath: /var/lib/containers
      name: varlibcontainers
----

- To do this, create `test-build-task.yaml` as follows.

IMPORTANT:
Do not name your task too long or you will get errors about Kubernetes resources has invalid names. Keep task and pipeline names less than 40 characters long.

[source, yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: nodejs-express-test-build-task
spec:
  inputs:
    resources:
      - name: git-source
        type: git
    params:
      - name: pathToDockerFile
        default: /workspace/extracted/Dockerfile
      - name: pathToContext
        default: /workspace/extracted
  outputs:
    resources:
      - name: docker-image
        type: image
  steps:
    - name: assemble-extract
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ["/bin/bash"]
      args:
        - -c
        - "/extract.sh"
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: npm-test
      securityContext:
        privileged: true
      image: kabanero/nodejs-express:0.2
      command: ["/bin/bash","-c","cd ${inputs.params.pathToContext}/user-app && ls && npm install --prefix user-app && npm install -g mocha && cd .. && npm test && npm test --prefix user-app"]
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: build-bud
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ['buildah', 'bud', '--tls-verify=false', '--format=docker', '-f', '${inputs.params.pathToDockerFile}', '-t', '${outputs.resources.docker-image.url}', '${inputs.params.pathToContext}']
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: build-push
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ['buildah', 'push', '--tls-verify=false', '${outputs.resources.docker-image.url}', 'docker://${outputs.resources.docker-image.url}']
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
  volumes:
    - name: varlibcontainers
      emptyDir: {}
----

- Once you create this yaml, create a task in `kabanero` namespace as follows.

[source, bash]
----
oc create -f test-build-task.yaml -n kabanero
----

Once you created it successfully, you will see something like below.

[source, bash]
----
$ oc create -f test-build-task.yaml -n kabanero
task.tekton.dev/nodejs-express-test-build-task created
----

- Verify it by using the below command.

[source, bash]
----
$ oc get task -n kabanero
NAME                             AGE
nodejs-express-test-build-task   1h
...
----

=== Custom Pipeline

Let us now create a new pipeline that includes the task we created earlier. We are replacing the default `build task` with the previous task in the new pipeline.

- Create `nodejs-express-test-build-deploy-pipeline.yaml` as follows.

[source, yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: nodejs-express-test-build-deploy-pipeline
spec:
  resources:
    - name: git-source
      type: git
    - name: docker-image
      type: image
  tasks:
    - name: nodejs-express-test-build-task
      taskRef:
        name: nodejs-express-test-build-task
      resources:
        inputs:
        - name: git-source
          resource: git-source
        outputs:
        - name: docker-image
          resource: docker-image
    - name: deploy-task
      taskRef:
        name: nodejs-express-deploy-task
      runAfter: [nodejs-express-test-build-task]
      resources:
        inputs:
        - name: git-source
          resource: git-source
        - name: docker-image
          resource: docker-image
----

- Once you create this yaml, create a new pipeline in `kabanero` namespace as follows.

[source, bash]
----
oc create -f nodejs-express-test-build-deploy-pipeline.yaml -n kabanero
----

Once you created it successfully, you will see something like below.

[source, bash]
----
$ oc create -f nodejs-express-test-build-deploy-pipeline.yaml -n kabanero
pipeline.tekton.dev/nodejs-express-test-build-deploy-pipeline created
----

- Verify it by using the below command.

[source, bash]
----
$ oc get pipeline  -n kabanero
NAME                                           AGE
nodejs-express-test-build-deploy-pipeline      1h
...
----

=== Create a webhook

- Access the tekton dashboard and now you should be able to see the new pipeline in the list.

image::sb_custom_pipeline_tekton_home.png[align="center"]

- Configure the github webhook to your repo. Go to `Webhooks` > `Add Webhook` and then create the webhook.

image::sb_custom_pipeline_tekton_webhook.png[align="center"]

- Verify if it is created successfully.

image::sb_custom_pipeline_tekton_webhooks.png[align="center"]

For more detailed instructions on how to create webhook, refer <<e2e-nodejs-express.adoc#_create_tekton_webhook_for_git_repo, Create Tekton webhook for git repo>>.

=== Verify the pipeline

- Make any changes to your app and push it to github.

- This will trigger the tekton pipleine.

- Go to the tekton dashboard and access the new pipeline we created.

image::sb_custom_pipeline_tekton_home.png[align="center"]

- Wait till the task is completed and then click on the Pipeline Run.

image::sb_custom_pipeline_tekton_pipeline_run.png[align="center"]

- Once the tasks are all completed, you will see something like below.

image::sb_custom_pipeline_tekton_pipeline_run_tasks.png[align="center"]

== Java Springboot

Before defining a new task or pipeline, make sure, you do the following steps.

- Create a java springboot appsody sample application.
- Push the code to a github repo.
- Create a github access token.
- Access tekton dashboard.

If you did not perform any of the above steps, go to the links provided in the prerequisites.

=== Custom Task

Let us include `mvn test` as one of the steps in our new task along with the ones that come by default.

- In this task, we are adding the below step additionally to the ones that come by default.

[source, yaml]
----
- name: mvn-test
  securityContext:
    privileged: true
  image: kabanero/java-spring-boot2:0.3
  command: ["/bin/bash","-c","cd ${inputs.params.pathToContext} && mvn test -f appsody-boot2-pom.xml"]
  env:
    - name: gitsource
      value: git-source
  volumeMounts:
    - mountPath: /var/lib/containers
      name: varlibcontainers
----

- To do this, create `test-build-task.yaml` as follows.

[source, yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: java-spring-boot2-test-build-task
spec:
  inputs:
    resources:
      - name: git-source
        type: git
    params:
      - name: pathToDockerFile
        default: /workspace/extracted/Dockerfile
      - name: pathToContext
        default: /workspace/extracted
  outputs:
    resources:
      - name: docker-image
        type: image
  steps:
    - name: assemble-extract
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ["/bin/bash"]
      args:
        - -c
        - "/extract.sh"
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: mvn-test
      securityContext:
        privileged: true
      image: kabanero/java-spring-boot2:0.3
      command: ["/bin/bash","-c","cd ${inputs.params.pathToContext} && mvn test -f appsody-boot2-pom.xml"]
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: build-bud
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ['buildah', 'bud', '--tls-verify=false', '--format=docker', '-f', '${inputs.params.pathToDockerFile}', '-t', '${outputs.resources.docker-image.url}', '${inputs.params.pathToContext}']
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: build-push
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ['buildah', 'push', '--tls-verify=false', '${outputs.resources.docker-image.url}', 'docker://${outputs.resources.docker-image.url}']
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
  volumes:
    - name: varlibcontainers
      emptyDir: {}
----

- Once you create this yaml, create a task in `kabanero` namespace as follows.

[source, bash]
----
oc create -f test-build-task.yaml -n kabanero
----

Once you created it successfully, you will see something like below.

[source, bash]
----
$ oc create -f test-build-task.yaml -n kabanero
task.tekton.dev/java-spring-boot2-test-build-task created
----

- Verify it by using the below command.

[source, bash]
----
$ oc get task -n kabanero
NAME                                AGE
java-spring-boot2-test-build-task   9m
----

=== Custom Pipeline

Let us now create a new pipeline that includes the task we created earlier. We are replacing the default `build task` with the previous task in the new pipeline.

- Create `java-spring-boot2-build-deploy-pipeline.yaml` as follows.

[source, yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: java-spring-boot2-test-build-deploy-pipeline
spec:
  resources:
    - name: git-source
      type: git
    - name: docker-image
      type: image
  tasks:
    - name: java-spring-boot2-test-build-task
      taskRef:
        name: java-spring-boot2-test-build-task
      resources:
        inputs:
        - name: git-source
          resource: git-source
        outputs:
        - name: docker-image
          resource: docker-image
    - name: deploy-task
      taskRef:
        name: java-spring-boot2-deploy-task
      runAfter: [java-spring-boot2-test-build-task]
      resources:
        inputs:
        - name: git-source
          resource: git-source
        - name: docker-image
          resource: docker-image
----

- Once you create this yaml, create a new pipeline in `kabanero` namespace as follows.

[source, bash]
----
oc create -f java-spring-boot2-build-deploy-pipeline.yaml -n kabanero
----

Once you created it successfully, you will see something like below.

[source, bash]
----
$ oc create -f java-spring-boot2-build-deploy-pipeline.yaml -n kabanero
pipeline.tekton.dev/java-spring-boot2-test-build-deploy-pipeline created
----

- Verify it by using the below command.

[source, bash]
----
$ oc get pipeline -n kabanero
NAME                                           AGE
java-spring-boot2-test-build-deploy-pipeline   37m
----

=== Create a webhook

- Access the tekton dashboard and now you should be able to see the new pipeline in the list.

image::sb_custom_pipeline_tekton_java_sb2.png[align="center"]

- Configure the github webhook to your repo. Go to `Webhooks` > `Add Webhook` and then create the webhook.

image::sb_custom_pipeline_tekton_webhook_java_sb2.png[align="center"]

- Verify if it is created successfully.

image::sb_custom_pipeline_tekton_webhooks_java_sb2.png[align="center"]

For more detailed instructions on how to create webhook, refer <<e2e-java-spring-boot2.adoc#_create_tekton_webhook_for_git_repo, Create Tekton webhook for git repo>>.

=== Verify the pipeline

- Make any changes to your app and push it to github.

- This will trigger the tekton pipleine.

- Go to the tekton dashboard and access the new pipeline we created.

image::sb_custom_pipeline_tekton_java_sb2.png[align="center"]

- Wait till the task is completed and then click on the Pipeline Run.

image::sb_custom_pipeline_task_java_sb2.png[align="center"]

- Once the tasks are all completed, you will see something like below.

image::sb_custom_pipeline_tekton_pipeline_run_tasks_java.png[align="center"]

NOTE: Currently, the `buildahbud` step fails due to the absence of JDK version as it got deleted. The issue is tracked https://github.com/kabanero-io/collections/issues/97[here].

NOTE: For java-spring-boot2, `mvn test` only works on the pom defined for stack and it fails on the application pom. The issue is tracked https://github.com/kabanero-io/collections/issues/96[here].

== Java Microprofile

Before defining a new task or pipeline, make sure, you do the following steps.

- Create a java microprofile appsody sample application.
- Push the code to a github repo.
- Create a github access token.
- Access tekton dashboard.

If you did not perform any of the above steps, go to the links provided in the prerequisites.

=== Custom Task

Let us include `mvn test` as one of the steps in our new task along with the ones that come by default.

- In this task, we are adding the below step additionally to the ones that come by default.

[source, yaml]
----
- name: mvn-test
  securityContext:
    privileged: true
  image: kabanero/java-microprofile:0.2
  command: ["/bin/bash","-c","cd ${inputs.params.pathToContext} && mvn test"]
  env:
    - name: gitsource
      value: git-source
  volumeMounts:
    - mountPath: /var/lib/containers
      name: varlibcontainers
----

- To do this, create `test-build-task.yaml` as follows.

[source, yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: java-microprofile-test-build-task
spec:
  inputs:
    resources:
      - name: git-source
        type: git
    params:
      - name: pathToDockerFile
        default: /workspace/extracted/Dockerfile
      - name: pathToContext
        default: /workspace/extracted
  outputs:
    resources:
      - name: docker-image
        type: image
  steps:
    - name: assemble-extract
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ["/bin/bash"]
      args:
        - -c
        - "/extract.sh"
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: mvn-test
      securityContext:
        privileged: true
      image: kabanero/java-microprofile:0.2
      command: ["/bin/bash","-c","cd ${inputs.params.pathToContext} && mvn test"]
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: build-bud
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ['buildah', 'bud', '--tls-verify=false', '--format=docker', '-f', '${inputs.params.pathToDockerFile}', '-t', '${outputs.resources.docker-image.url}', '${inputs.params.pathToContext}']
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
    - name: build-push
      securityContext:
        privileged: true
      image: appsody/appsody-buildah
      command: ['buildah', 'push', '--tls-verify=false', '${outputs.resources.docker-image.url}', 'docker://${outputs.resources.docker-image.url}']
      env:
        - name: gitsource
          value: git-source
      volumeMounts:
        - mountPath: /var/lib/containers
          name: varlibcontainers
  volumes:
    - name: varlibcontainers
      emptyDir: {}
----

- Once you create this yaml, create a task in `kabanero` namespace as follows.

[source, bash]
----
oc create -f test-build-task.yaml -n kabanero
----

Once you created it successfully, you will see something like below.

[source, bash]
----
oc create -f test-build-task.yaml -n kabanero
task.tekton.dev/java-microprofile-test-build-task created
----

- Verify it by using the below command.

[source, bash]
----
oc get task -n kabanero
NAME                                AGE
java-microprofile-test-build-task   23m
----

=== Custom Pipeline

Let us now create a new pipeline that includes the task we created earlier. We are replacing the default `build task` with the previous task in the new pipeline.

- Create `java-microprofile-test-build-deploy-pipeline.yaml` as follows.

[source, yaml]
----
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: java-microprofile-test-build-deploy-pipeline
spec:
  resources:
    - name: git-source
      type: git
    - name: docker-image
      type: image
  tasks:
    - name: build-task
      taskRef:
        name: java-microprofile-test-build-task
      resources:
        inputs:
        - name: git-source
          resource: git-source
        outputs:
        - name: docker-image
          resource: docker-image
    - name: deploy-task
      taskRef:
        name: java-microprofile-deploy-task
      runAfter: [build-task]
      resources:
        inputs:
        - name: git-source
          resource: git-source
        - name: docker-image
          resource: docker-image
----

- Once you create this yaml, create a new pipeline in `kabanero` namespace as follows.

[source, bash]
----
oc create -f java-microprofile-test-build-deploy-pipeline.yaml -n kabanero
----

Once you created it successfully, you will see something like below.

[source, bash]
----
$ oc create -f java-microprofile-test-build-deploy-pipeline.yaml -n kabanero
pipeline.tekton.dev/java-microprofile-test-build-deploy-pipeline created
----

- Verify it by using the below command.

[source, bash]
----
$ oc get pipeline -n kabanero
NAME                                           AGE
java-microprofile-test-build-deploy-pipeline   27m
----

=== Create a webhook

- Access the tekton dashboard and now you should be able to see the new pipeline in the list.

image::mp_custom_pipeline_tekton.png[align="center"]

- Configure the github webhook to your repo. Go to `Webhooks` > `Add Webhook` and then create the webhook.

image::mp_custom_pipeline_tekton_webhook.png[align="center"]

- Verify if it is created successfully.

image::mp_custom_pipeline_tekton_webhooks.png[align="center"]

For more detailed instructions on how to create webhook, refer <<e2e-java-microprofile.adoc#_create_tekton_webhook_for_git_repo, Create Tekton webhook for git repo>>.

=== Verify the pipeline

- Make any changes to your app and push it to github.

- This will trigger the tekton pipleine.

- Go to the tekton dashboard and access the new pipeline we created.

image::mp_custom_pipeline_tekton.png[align="center"]

- Wait till the task is completed and then click on the Pipeline Run.

image::mp_custom_pipeline_task.png[align="center"]

- Once the tasks are all completed, you will see something like below.

image::mp_custom_pipeline_tekton_pipeline_run_tasks.png[align="center"]

NOTE: Currently, the `buildahbud` step fails due to the absence of JDK version as it got deleted. The issue is tracked https://github.com/kabanero-io/collections/issues/97[here].

NOTE: For java-spring-boot2, `mvn test` only works on the pom defined for stack and it fails on the application pom. The issue is tracked https://github.com/kabanero-io/collections/issues/96[here].
